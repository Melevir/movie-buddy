# Implementation Plan: Personal Recommendations

**Branch**: `002-personal-recommendations` | **Date**: 2026-02-13 | **Spec**: `specs/002-personal-recommendations/spec.md`
**Input**: Feature specification from `/specs/002-personal-recommendations/spec.md`

## Summary

Add user ratings for movies/series and LLM-powered personalized
recommendations to movie_buddy. Users rate content from their
kino.pub watching history (stored in Turso cloud SQLite), build a
catalog of recommendation candidates via category endpoints, and
get 3 tailored suggestions from OpenAI GPT-4o-mini based on their
taste profile and a natural language description.

## Technical Context

**Language/Version**: Python 3.13+
**Primary Dependencies**: Typer (CLI), httpx (HTTP), Rich (terminal UX), cryptography (token encryption), python-dotenv (env config), openai (LLM), libsql-client (Turso)
**Storage**: Turso (cloud-hosted SQLite via libSQL) — ratings + catalog tables
**Testing**: pytest + pytest-httpx
**Target Platform**: macOS (primary), Linux
**Project Type**: Single CLI application
**Performance Goals**: Recommendations returned within 15 seconds; catalog fetch under 30 seconds
**Constraints**: Free-tier services only (Turso: 500M reads/10M writes/month; OpenAI: user-provided key)
**Scale/Scope**: Single user, ~1000-5000 catalog entries, ~50-200 ratings

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Test-First | PASS | All sprints follow TDD (red-green-refactor). Tests before implementation. pytest-httpx for API mocking, mock for LLM and storage. |
| II. Simplicity / YAGNI | PASS | Two new dependencies justified: `openai` (no stdlib LLM alternative), `libsql-client` (no stdlib Turso alternative). Flat module structure. No speculative abstractions. |
| III. Mindful UX | PASS | Rich panels for rating prompts, Rich tables for ratings/recommendations, spinner for LLM calls, progress bars for catalog fetch. Actionable error messages. |
| No secrets in VC | PASS | `OPENAI_API_KEY`, `TURSO_DATABASE_URL`, `TURSO_AUTH_TOKEN` all in `.env` (gitignored). `.env.example` with empty placeholders. |

## Project Structure

### Documentation (this feature)

```text
specs/002-personal-recommendations/
├── plan.md              # This file
├── research.md          # Phase 0: technical research decisions
├── data-model.md        # Phase 1: entity definitions + SQL schema
├── quickstart.md        # Phase 1: integration scenarios
├── contracts/
│   └── cli-commands.md  # Phase 1: CLI command contracts
└── tasks.md             # Phase 2: task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
movie_buddy/
├── __init__.py
├── __main__.py
├── cli.py               # Extended: rate, recommend, catalog, ratings commands
├── api.py               # Extended: watching history + catalog category endpoints
├── auth.py              # Existing (reused)
├── models.py            # Extended: CatalogEntry, Rating, Recommendation dataclasses
├── browser.py           # Existing (reused by recommend → open)
├── config.py            # Extended: Turso + OpenAI env vars
├── matcher.py           # Existing (unchanged)
├── storage.py           # NEW: Turso client (init schema, CRUD for ratings + catalog)
└── recommender.py       # NEW: OpenAI integration (build prompt, parse response)

tests/
├── conftest.py          # Extended: storage + recommender fixtures
├── test_api.py          # Extended: watching history + catalog endpoint tests
├── test_cli.py          # Extended: rate, recommend, catalog, ratings command tests
├── test_storage.py      # NEW: Turso storage unit tests (mocked libsql)
├── test_recommender.py  # NEW: LLM recommender unit tests (mocked openai)
├── test_models.py       # Extended: new dataclass tests
└── fixtures/            # Extended: watching history + catalog API response fixtures
```

**Structure Decision**: Flat single-package structure (consistent with
existing codebase). Two new modules (`storage.py`, `recommender.py`)
each own a single responsibility. No sub-packages needed at this scale.

## Sprint Plan

### Sprint 1: Storage foundation + data models (US1 prerequisite)

New dataclasses in `models.py` (CatalogEntry, Rating, Recommendation).
Turso storage client in `storage.py` with schema init, ratings CRUD,
catalog CRUD. Config extension for Turso env vars. All TDD.

### Sprint 2: Catalog command (FR-017)

API client extension for category endpoints (fresh/hot/popular).
`catalog` CLI command with progress display, deduplication, summary.
Incremental growth. All TDD.

### Sprint 3: Rating command (US1, FR-001 through FR-006)

API client extension for watching history endpoint. `rate` CLI
command: fetch history, filter rated, present 10 for rating, persist
to Turso. Skip/quit support. Summary. All TDD.

### Sprint 4: Recommendation engine (US2, FR-007 through FR-012)

OpenAI recommender in `recommender.py`: taste profile builder,
prompt construction, structured output parsing. `recommend` CLI
command: validate prerequisites (≥5 ratings, non-empty catalog),
spinner, display table, open selection in Chrome. All TDD.

### Sprint 5: Ratings management + polish (US3, FR-013 through FR-015)

`ratings` CLI command: formatted table display, `--clear` flag with
confirmation. Error handling polish for all new commands (missing env
vars, network errors, LLM errors). `.env.example` update. All TDD.

## Complexity Tracking

No constitution violations to justify. Two new dependencies and two
new modules are the minimum required for the feature scope.
