name: CI

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Create .env for CI
        run: |
          echo "KINOPUB_CLIENT_ID=ci_test" >> .env
          echo "KINOPUB_CLIENT_SECRET=ci_test" >> .env

      - name: Lint
        id: lint
        run: ruff check . 2>&1 | tee lint_output.txt

      - name: Format check
        id: format
        run: ruff format --check . 2>&1 | tee format_output.txt

      - name: Type check
        id: typecheck
        run: mypy movie_buddy/ 2>&1 | tee typecheck_output.txt

      - name: Tests
        id: tests
        run: python -m pytest tests/ -q 2>&1 | tee test_output.txt

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const read = (f) => { try { return fs.readFileSync(f, 'utf8').trim(); } catch { return 'No output'; } };

            const lint = read('lint_output.txt');
            const format = read('format_output.txt');
            const typecheck = read('typecheck_output.txt');
            const tests = read('test_output.txt');

            const lintOk = '${{ steps.lint.outcome }}' === 'success';
            const formatOk = '${{ steps.format.outcome }}' === 'success';
            const typecheckOk = '${{ steps.typecheck.outcome }}' === 'success';
            const testsOk = '${{ steps.tests.outcome }}' === 'success';
            const allOk = lintOk && formatOk && typecheckOk && testsOk;

            const icon = (ok) => ok ? ':white_check_mark:' : ':x:';

            const body = `## CI Report ${allOk ? ':white_check_mark:' : ':x:'}

            | Check | Status |
            |---|---|
            | Lint (ruff check) | ${icon(lintOk)} |
            | Format (ruff format) | ${icon(formatOk)} |
            | Type check (mypy) | ${icon(typecheckOk)} |
            | Tests (pytest) | ${icon(testsOk)} |

            <details><summary>Lint</summary>

            \`\`\`
            ${lint}
            \`\`\`
            </details>

            <details><summary>Format</summary>

            \`\`\`
            ${format}
            \`\`\`
            </details>

            <details><summary>Type check</summary>

            \`\`\`
            ${typecheck}
            \`\`\`
            </details>

            <details><summary>Tests</summary>

            \`\`\`
            ${tests}
            \`\`\`
            </details>`.replace(/^            /gm, '');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
